# FiTx: Framework for Finger Traceable Bugs in Linux
## Overview
This repository contains the artifacts for USENIX ATC 2024 Paper:

> Keita Suzuki, Kenta Ishiguro, Kenji Kono, "Balancing Analysis Time and Bug Detection: Daily Development-friendly Bug Detection in Linux", In 2024 USENIX Annual Technical Conference (to appear), 2024

## Prerequisites
- A Linux machine (Ubuntu 20.04 recommended)
- Network access
- A decent amount of memory and disk storage to compile Linux kernel with `allyesconfig`
    - RAM: Preferably 32 GB or more
    - Disk storage: At least 100GB
- Software
    - Docker and docker-compose to run the experiments

### Experimental Setup
Our experiments are conducted using the following setup (taken from the paper):

|Setup|Version|
|:---:|:---:|
|OS                  | Ubuntu 20.04                  |
|CPU                 | 16 Core Intel Xeon CPU E5-2620|
|RAM                 | 96 GB (limited to 32 GB)      |
|LLVM                | 10.0.1                        |
|Target Linux Version| v5.15                         |
|Config              | allyesconfig                  |


## Directory overview
- `//src` : includes all the relevant source files for FiTx and the detectors
- `//test`: includes the test source code to conduct simple functional testing of FiTx
- `//scripts`:  includes experimental scripts as well as some configuration files

## Getting Started Guide
### Using Docker Container
Assuming that Docker and docker-compose is installed, run the following command
to start the container:

```
docker-compose up --build -d
```

This will install the relevant packages, build FiTx, and download Linux kernel
with the version used in the experiments within the container.

### Manual instructions
If you need to manually build your own enviornment to use FiTx, please conduct
the following: 

#### Install LLVM
1. Install LLVM 10.0.1. Follow Getting Started Guilde from [llvm.org](https://llvm.org/docs/GettingStarted.html)
1. To use the scripts, install python3, pip3 and install packages in requirements.txt

#### Building FiTx
FiTx can be built using CMake.

1. Download this repository
1. Run `cmake -S [PATH_TO_FITX]/src -B [PATH_TO_FITX]/build`
1. In build directory, run build by making `make -j${nproc}`


### Running Tests
Run the following command to run FiTx on a test source code. By default, tests
are mounted to `/tmp/tests` within the container.

```
# Script template
docker exec [ContaierName HERE] python3 /FiTx/scripts/analyze.py tests PATH_TO_TEST

# Example of running double free tests
docker exec [ContaierName HERE] python3 /FiTx/scripts/analyze.py tests /tmp/tests/double_free
```
The script will deal with identifying the source files within each directory,
running analysis on them, and printing the analysis log as output if there are
any. Empty log indicates no bug was found.

To check if the log is correctly pointing to a bug (or not pointing to a bug),
please refer to log files in `[PATH_TO_TEST]/expected/[TEST_NAME].log` which
stores the expected log for each testcase (or check the testcase file and
manually confirm the bug). For instance, if you are testing
`/tmp/tests/double_free/src/intra_procedural_df.c`, the expected log will be
`/tmp/tests/double_free/expected/intra_procedural_df.log`.

### Reading the log
Each log generated by FiTx will look like the following:
```
[ERROR] /tmp/tests/double_free/src/intra_procedural_df.c:32:3: --- [double free] ---
[ERROR] /tmp/tests/double_free/src/intra_procedural_df.c:32:3: [framework::Value] ValueType: 55 Array Element: -2 ({Type: i8* Field: -1}, )
  [LOG] /tmp/tests/double_free/src/intra_procedural_df.c:28:5: [Transition] init to free
  [LOG] /tmp/tests/double_free/src/intra_procedural_df.c:32:3: [Transition] free to double free
```
The first line indicates the type of bug that was identified (`[double free]`).
The second line will indicate the type of the value (Refer to later section on details).
The remaining lines with `[LOG]` tag indicate where the state transition occurred
within each source file.

#### How to read the values
TODO

### [Optional] Compiling Linux Kernel
This section is completely optional as compiling Linux kernel will be handled
in later sections when running FiTx on Linux source.

Run the following command to make sure the Linux kernel can be compiled within
the container:

> [!WARNING]
> Running the following command will trigger a `allyesconfig` compilation
> and will take a long time to complete

```
docker exec linux_bug_detection_framework_llvm_1 make CC=clang HOSTCC=clang -j4 LLVM_IAS=0 -C [PATH_TO_LINUX: default is `/linux`]
```

> [!NOTE]
> Please make sure to run `make clean` inside the container after compilation.

## Running FiTx on Linux
To run FiTx on Linux, run the following command:
```
docker exec [ContaierName HERE] python3 /FiTx/scripts/analyze.py linux
```
This will run the analysis on the downloaded Linux kernel. Please make sure that
the Linux kernel builds are clean (i.e. run `make clean`) before starting this
script. By default, the logs will be stored inside `/tmp/log/[datetime_of_analysis].log`.

## Reproducing the main contribution of the paper

The main contribution of our paper is as follows:

- XXX

### 1. Bugs detection with FiTx
TODO

### 2. Measuring analysis time of each source file
TODO

### 3. TODO
